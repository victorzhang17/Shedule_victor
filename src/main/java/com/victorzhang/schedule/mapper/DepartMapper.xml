<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.victorzhang.schedule.mapper.DepartMapper">

	<resultMap type="com.victorzhang.schedule.pojo.Depart" id="depart">
		<id column="departid" property="departid"/>
		<result column="dname" property="dname"/>
		<result column="dphone" property="dphone"/>
		<result column="address" property="address"/>
		<result column="connperson" property="connperson"/>
		<result column="connphone" property="connphone"/>
	</resultMap>

	<!-- 部门总数 -->
	<select id="queryCount" resultType="int" parameterType="java.util.Map">
		SELECT count(departid) FROM department
		<where>
			<if test="dname != null and dname != ''">
				and dname = #{dname}
			</if>
		</where>
	</select>

	<!-- 部门总记录 -->
	<select id="queryDepartInfos" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT departid,dname,dphone,address,connperson,connphone FROM department
		<where>
			<if test="dname != null and dname != ''">
				dname = #{dname}
			</if>
		</where>
		ORDER BY ddate DESC limit ${begin},${pageSize}
	</select>
	
	<!-- 获取当前部门下所有班级(系统管理员权限) -->
	<select id="queryClassesByDepartid" resultType="java.util.Map" parameterType="java.lang.String">
		SELECT cname FROM classes
		WHERE departid = #{departid}
	</select>
	
	<!-- 获取当前学院信息(系统管理员权限) -->
	<select id="getDepartInfo" resultMap="depart" parameterType="java.lang.String">
		SELECT departid,dname,dphone,address,connperson,connphone
		FROM department
		WHERE departid = #{departid}
	</select>
	
	<!-- 更新部门信息(系统管理员权限) -->
	<update id="doUpdateDepart" parameterType="java.util.Map">
		UPDATE department SET
		dname = #{dname},address=#{address}
		<if test="dphone != null and dphone != ''">
			,dphone=#{dphone}
		</if>
		<if test="connperson != null and connperson != ''">
			,connperson=#{connperson}
		</if>
		<if test="connphone != null and connphone != ''">
			,connphone=#{connphone}
		</if>
		WHERE departid = #{departid}
	</update>
	
	<!-- 删除当前学院，联表删除包括所有下属班级和学生，教师(系统管理员权限) -->
	<delete id="deleteDepart" parameterType="java.lang.String">
		Delete department,classes,users FROM department
		LEFT JOIN classes
		ON department.departid = classes.departid
		LEFT JOIN users
		ON department.departid = users.departid
		where department.departid = #{departid}
	</delete>
	
	<!-- 添加学院(系统管理员权限) -->
	<insert id="addDepart" parameterType="java.util.Map">
		insert into department 
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="departid != null and departid != ''">
				departid,
			</if>
			<if test="dname != null and dname != ''">
				dname,
			</if>
			<if test="dphone != null and dphone != ''">
				dphone,
			</if>
			<if test="address != null and address != ''">
				address,
			</if>
			<if test="connperson != null and connperson != ''">
				connperson,
			</if>
			<if test="connphone != null and connphone != ''">
				connphone,
			</if>
			<if test="ddate != null and ddate != ''">
				ddate,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="departid != null and departid != ''">
				#{departid},
			</if>
			<if test="dname != null and dname != ''">
				#{dname},
			</if>
			<if test="dphone != null and dphone != ''">
				#{dphone},
			</if>
			<if test="address != null and address != ''">
				#{address},
			</if>
			<if test="connperson != null and connperson != ''">
				#{connperson},
			</if>
			<if test="connphone != null and connphone != ''">
				#{connphone},
			</if>
			<if test="ddate != null and ddate != ''">
				#{ddate},
			</if>
		</trim>
	</insert>
	
	<!-- 根据学院名称获取学院id -->
	<select id="getDepartidByDname" resultType="java.lang.String" parameterType="java.lang.String">
		SELECT departid
		FROM department
		WHERE dname = #{dname}
	</select>
</mapper>