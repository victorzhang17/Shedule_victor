<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.victorzhang.schedule.mapper.LogMapper">

	<!-- 加入日志-->
	<insert id="addLog" parameterType="java.util.Map">
		insert into log
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="logid != null and logid != ''">
				logid,
			</if>
			<if test="loglx != null and loglx != ''">
				loglx,
			</if>
			<if test="logms != null and logms != ''">
				logms,
			</if>
			<if test="userid != null and userid != ''">
				userid,
			</if>
			<if test="departid != null and departid != ''">
				departid,
			</if>
			<if test="userdate != null and userdate != ''">
				userdate,
			</if>
			<if test="userip != null and userip != ''">
				userip,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="logid != null and logid != ''">
				#{logid},
			</if>
			<if test="loglx != null and loglx != ''">
				#{loglx},
			</if>
			<if test="logms != null and logms != ''">
				#{logms},
			</if>
			<if test="userid != null and userid != ''">
				#{userid},
			</if>
			<if test="departid != null and departid != ''">
				#{departid},
			</if>
			<if test="userdate != null and userdate != ''">
				#{userdate},
			</if>
			<if test="userip != null and userip != ''">
				#{userip},
			</if>
		</trim>
	</insert>
	
	<!-- 日志总数 -->
	<select id="queryCount" resultType="int" parameterType="java.util.Map">
		SELECT COUNT(logid) FROM log l  
		LEFT JOIN users u 
		ON l.userid = u.userid
		LEFT JOIN department d 
		ON l.departid = d.departid
		<where>
			<if test="loglx != null and loglx != ''">
					and l.loglx = #{loglx}
			</if>
			<if test="userid != null and userid != ''">
					and l.userid = #{userid}
			</if>
			<if test="dname != null and dname != ''">
					and d.dname = #{dname}
			</if>
			<if test="departid != null and departid != ''">
					and l.departid = #{departid}
			</if>
			<if test="stadate != null and stadate != ''">
					and l.userdate >= #{stadate}
			</if>
			<if test="enddate != null and enddate != ''">
					and #{enddate} >= l.userdate
			</if>
		</where>
	</select>
	
	<!-- 日志记录 -->
	<select id="querylogpage" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT DATE_FORMAT(l.userdate,'%Y-%m-%d %H:%h:%s') AS userdate,l.loglx,l.logms,l.userip,u.username,u.realname FROM log l 
		LEFT JOIN users u ON
		l.userid = u.userid
		<where>
			<if test="loglx != null and loglx != ''">
					and l.loglx = #{loglx}
			</if>
			<if test="userid != null and userid != ''">
					and l.userid = #{userid}
			</if>
			<if test="stadate != null and stadate != ''">
					and l.userdate >= #{stadate}
			</if>
			<if test="enddate != null and enddate != ''">
					and #{enddate} >= l.userdate
			</if>
		</where>
		ORDER BY l.userdate DESC LIMIT ${begin},${pageSize}
	</select>
	
	<!-- 查看当前用户所有日志类型 -->
	<select id="queryAllLogLx" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT DISTINCT(loglx) FROM log
		<where>
			<if test="userid != null and userid != ''">
					and userid = #{userid}
			</if>
			<if test="departid != null and departid != ''">
					and departid = #{departid}
			</if>
		</where>
	</select>
	
</mapper>